name: publish bottles

on:
  pull_request_target:
    types:
      - labeled

env:
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}
  TAP_DIR_BASE: /home/linuxbrew/.linuxbrew/Homebrew/Library/Taps

jobs:
  publish:
    if: contains(github.event.pull_request.labels.*.name, 'pr-pull')
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      pull-requests: write

    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git
        uses: Homebrew/actions/git-user-config@main

      - name: Tap and checkout PR branch
        run: |
          brew tap ${{ env.REPO_OWNER }}/${{ env.REPO_NAME }} https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}
          TAP_DIR="${{ env.TAP_DIR_BASE }}/${{ env.REPO_OWNER }}/homebrew-${{ env.REPO_NAME }}"
          cd "$TAP_DIR"
          PR="${{ github.event.pull_request.number }}"
          git fetch origin "+refs/pull/${PR}/head:refs/remotes/origin/pr-${PR}"
          git checkout -b "pr-${PR}" "origin/pr-${PR}"

      - name: Find test workflow run ID
        id: find-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          RUN_ID="$(gh run list \
            --repo "$GITHUB_REPOSITORY" \
            --workflow "tests.yml" \
            --branch "$PR_BRANCH" \
            --status success \
            --limit 1 \
            --json databaseId \
            -q '.[0].databaseId')"
          echo "run-id=${RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Download bottle artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "===== DEBUG: BEFORE DOWNLOAD ====="
          pwd
          ls -R || true

          for os in macos-26 macos-15 macos-15-intel; do
            echo "Downloading artifact: bottles_${os}"
            gh run download "${{ steps.find-run.outputs.run-id }}" \
              --repo "$GITHUB_REPOSITORY" \
              --name "bottles_${os}" \
              --dir ./bottles
          done

          echo "===== DEBUG: AFTER DOWNLOAD ====="
          pwd
          echo "Directory tree:"
          ls -R bottles || true

          echo "Find tarballs:"
          find bottles -type f -name '*.tar.gz' -print || true

          echo "Find bottle json:"
          find bottles -type f -name '*.bottle.json' -print || true

      - name: Upload bottles to release
        id: upload
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="$(gh release view --repo "$GITHUB_REPOSITORY" --json tagName -q .tagName)"
          echo "release-tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"

          # Rename local_filename (--) to filename (-) before uploading
          find bottles -name '*--*' | while read f; do
            renamed="${f/--/-}"
            mv "$f" "$renamed"
          done

          shopt -s globstar nullglob
          files=(bottles/**/*.tar.gz)

          if (( ${#files[@]} == 0 )); then
            echo "ERROR: No bottle files matched"
            exit 1
          fi

          gh release upload "$RELEASE_TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --clobber \
            "${files[@]}"

      - name: Merge bottle block into formula
        run: |
          TAP_DIR="${{ env.TAP_DIR_BASE }}/${{ env.REPO_OWNER }}/homebrew-${{ env.REPO_NAME }}"
          cd "$TAP_DIR"
          git checkout main
          git pull origin main
          PR="${{ github.event.pull_request.number }}"
          git merge --no-edit "origin/pr-${PR}"
          brew bottle --merge --write \
            "$GITHUB_WORKSPACE"/bottles/*.bottle.json

      - name: Push commits
        uses: Homebrew/actions/git-try-push@main
        with:
          directory: ${{ env.TAP_DIR_BASE }}/${{ env.REPO_OWNER }}/homebrew-${{ env.REPO_NAME }}
          branch: main

      - name: Delete branch
        if: github.event.pull_request.head.repo.fork == false
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh api -X DELETE "repos/$GITHUB_REPOSITORY/git/refs/heads/$BRANCH"
