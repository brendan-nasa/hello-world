name: publish bottles
on:
  pull_request_target:
    types:
      - labeled

jobs:
  publish:
    if: contains(github.event.pull_request.labels.*.name, 'pr-pull')
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      pull-requests: write

    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git
        uses: Homebrew/actions/git-user-config@main

      - name: Tap and checkout PR branch
        run: |
          brew tap brendan-nasa/hello-world https://github.com/brendan-nasa/hello-world
          TAP_DIR="$(brew --repository)/Library/Taps/brendan-nasa/homebrew-hello-world"
          cd "$TAP_DIR"
          PR="${{ github.event.pull_request.number }}"
          git fetch origin "+refs/pull/${PR}/head:refs/remotes/origin/pr-${PR}"
          git checkout -b "pr-${PR}" "origin/pr-${PR}"

      - name: Find test workflow run ID
        id: find-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          RUN_ID="$(gh run list \
            --repo "$GITHUB_REPOSITORY" \
            --workflow "brew test-bot" \
            --branch "$PR_BRANCH" \
            --status success \
            --limit 1 \
            --json databaseId \
            -q '.[0].databaseId')"
          echo "run-id=${RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Download bottle artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "===== DEBUG: BEFORE DOWNLOAD ====="
          pwd
          ls -R || true

          for os in macos-26 macos-15 macos-15-intel; do
            echo "Downloading artifact: bottles_${os}"
            gh run download "${{ steps.find-run.outputs.run-id }}" \
              --repo "$GITHUB_REPOSITORY" \
              --name "bottles_${os}" \
              --dir ./bottles
          done

          echo "===== DEBUG: AFTER DOWNLOAD ====="
          pwd
          echo "Directory tree:"
          ls -R bottles || true

          echo "Find tarballs:"
          find bottles -type f -name '*.tar.gz' -print || true

          echo "Find bottle json:"
          find bottles -type f -name '*.bottle.json' -print || true

      - name: Upload bottles to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="$(gh release view --repo "$GITHUB_REPOSITORY" --json tagName -q .tagName)"
          RELEASE_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}"
        
          echo "===== DEBUG: BEFORE UPLOAD ====="
          pwd
          ls -R bottles || true
      
          echo
          echo "===== DEBUG: RELEASE TAG VALUE ====="
          echo "RELEASE_TAG='$RELEASE_TAG'"
          echo "GITHUB_REPOSITORY='$GITHUB_REPOSITORY'"
      
          echo
          echo "===== DEBUG: LIST ALL RELEASES ====="
          gh release list --repo "$GITHUB_REPOSITORY" || true
      
          echo
          echo "===== DEBUG: VIEW SELECTED RELEASE ====="
          gh release view "$RELEASE_TAG" --repo "$GITHUB_REPOSITORY" || echo "Release NOT found"
      
          shopt -s globstar nullglob
      
          echo
          echo "===== DEBUG: GLOB EXPANSION ====="
          files=(bottles/**/*.tar.gz)
      
          echo "Matched file count: ${#files[@]}"
      
          for f in "${files[@]}"; do
            echo "MATCHED: $f"
          done
      
          echo
          echo "===== RUNNING UPLOAD ====="
      
          if (( ${#files[@]} == 0 )); then
            echo "ERROR: No bottle files matched"
            exit 1
          fi
      
          gh release upload "$RELEASE_TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --clobber \
            "${files[@]}"


      - name: Merge bottle block into formula
        env:
          ROOT_URL: ${{ steps.release.outputs.url }}
        run: |
          echo "===== DEBUG: MERGE STEP ====="
          pwd
          ls -R bottles || true

          brew bottle --merge --write --no-commit \
            --root-url="$ROOT_URL" \
            bottles/*.bottle.json

      - name: Push commits
        uses: Homebrew/actions/git-try-push@main
        with:
          directory: /home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/brendan-nasa/homebrew-hello-world
          branch: main

      - name: Delete branch
        if: github.event.pull_request.head.repo.fork == false
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh api -X DELETE "repos/$GITHUB_REPOSITORY/git/refs/heads/$BRANCH"
