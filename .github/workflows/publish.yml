name: publish bottles
on:
  pull_request_target:
    types:
      - labeled

jobs:
  publish:
    if: contains(github.event.pull_request.labels.*.name, 'pr-pull')
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      pull-requests: write

    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git
        uses: Homebrew/actions/git-user-config@main

      - name: Tap and checkout PR branch
        run: |
          brew tap brendan-nasa/hello-world https://github.com/brendan-nasa/hello-world
          TAP_DIR="$(brew --repository)/Library/Taps/brendan-nasa/homebrew-hello-world"
          cd "$TAP_DIR"
          PR="${{ github.event.pull_request.number }}"
          git fetch origin "+refs/pull/${PR}/head:refs/remotes/origin/pr-${PR}"
          git checkout -b "pr-${PR}" "origin/pr-${PR}"

      - name: Find test workflow run ID
        id: find-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          RUN_ID="$(gh run list \
            --repo "$GITHUB_REPOSITORY" \
            --workflow "tests.yml" \
            --branch "$PR_BRANCH" \
            --status success \
            --limit 1 \
            --json databaseId \
            -q '.[0].databaseId')"

          echo "Found run id: $RUN_ID"
          echo "run-id=${RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Download bottle artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for os in macos-26 macos-15 macos-15-intel; do
            gh run download "${{ steps.find-run.outputs.run-id }}" \
              --repo "$GITHUB_REPOSITORY" \
              --name "bottles_${os}" \
              --dir ./bottles
          done

          echo "Downloaded files:"
          find bottles -type f -print

      - name: Merge bottle block into formula
        run: |
          TAP_DIR="$(brew --repository)/Library/Taps/brendan-nasa/homebrew-hello-world"
          cd "$TAP_DIR"

          git checkout main
          git pull origin main

          PR="${{ github.event.pull_request.number }}"
          git merge --no-edit "origin/pr-${PR}"

          echo "Bottle JSON files:"
          find "$GITHUB_WORKSPACE/bottles" -name '*.bottle.json'

          brew bottle --merge --write \
            "$GITHUB_WORKSPACE"/bottles/*.bottle.json

          echo "After merge, tarball names are:"
          find "$GITHUB_WORKSPACE/bottles" -name '*.tar.gz'

      - name: Upload bottles to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Existing releases:"
          gh release list --repo "$GITHUB_REPOSITORY"

          RELEASE_TAG="$(gh release view --repo "$GITHUB_REPOSITORY" --json tagName -q .tagName)"

          echo "Chosen release tag: $RELEASE_TAG"

          shopt -s globstar nullglob
          files=(bottles/**/*.tar.gz)

          echo "Files to upload:"
          printf '%s\n' "${files[@]}"

          if (( ${#files[@]} == 0 )); then
            echo "ERROR: No bottles found after merge"
            exit 1
          fi

          gh release upload "$RELEASE_TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --clobber \
            "${files[@]}"

      - name: Push commits
        uses: Homebrew/actions/git-try-push@main
        with:
          directory: /home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/brendan-nasa/homebrew-hello-world
          branch: main

      - name: Delete branch
        if: github.event.pull_request.head.repo.fork == false
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh api -X DELETE "repos/$GITHUB_REPOSITORY/git/refs/heads/$BRANCH"
